---
---

<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storm Email Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 1.1 Paleta de Cores (Direção de Arte) */
            --bg-absolute: #000000;
            --bg-sidebar: #050505;
            --bg-panel: #0A0A0A;
            
            --card-surface: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(255, 255, 255, 0.06);
            
            /* Cores de Acento */
            --accent-purple: #723CEB;
            --accent-orange: #F4893C;
            --accent-gradient: linear-gradient(135deg, #723CEB 0%, #A855F7 100%);
            
            /* Tipografia */
            --text-primary: #FFFFFF;
            --text-secondary: #858585; /* Cinza médio para reduzir ruído */
            --text-tertiary: #4A4A4A;
            
            /* Formas */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            background-color: var(--bg-absolute);
            color: var(--text-primary); 
            height: 100vh; 
            font-family: 'Manrope', sans-serif;
            overflow: hidden;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT GRID DE 3 COLUNAS --- */
        .app-grid {
            display: grid;
            grid-template-columns: 260px 1fr 400px; /* Sidebar | Lista | Painel de Ação */
            height: 100%;
            width: 100%;
        }

        /* --- COLUNA 1: SIDEBAR --- */
        .sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--card-border);
            padding: 32px 20px;
            display: flex; flex-direction: column;
            justify-content: space-between;
        }

        .brand {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 48px;
            padding-left: 12px;
        }
        .brand-icon {
            width: 32px; height: 32px;
            background: var(--accent-gradient);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(114, 60, 235, 0.4);
        }
        .brand-text { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 4px; }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .nav-item:hover { color: var(--text-primary); background: rgba(255,255,255,0.02); }
        
        .nav-item.active { 
            background: var(--card-surface); 
            color: var(--text-primary); 
            font-weight: 600;
        }
        .nav-item.active .icon { color: var(--accent-purple); }

        /* --- COLUNA 2: LISTA DE CONTEÚDO --- */
        .main-list {
            background: var(--bg-absolute);
            padding: 40px;
            overflow-y: auto;
            border-right: 1px solid var(--card-border);
        }

        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 40px;
        }
        h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.8px; }
        .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 8px; }

        /* Cards List */
        .cards-container { display: flex; flex-direction: column; gap: 16px; }

        .card-item {
            background: var(--card-surface);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            padding: 24px;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        /* Efeito Hover Glass */
        .card-item:hover {
            transform: translateY(-2px);
            background: var(--card-hover);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.8);
        }

        /* Card Content Layout */
        .card-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .card-meta { display: flex; gap: 8px; align-items: center; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #333, #555);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700;
        }
        .purple-gradient { background: var(--accent-gradient); }

        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .card-preview { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

        /* Tags */
        .tag {
            padding: 4px 10px; border-radius: 100px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tag.purple { background: rgba(114, 60, 235, 0.15); color: #A78BFA; border: 1px solid rgba(114, 60, 235, 0.3); }
        .tag.orange { background: rgba(244, 137, 60, 0.15); color: #FDBA74; border: 1px solid rgba(244, 137, 60, 0.3); }

        /* --- COLUNA 3: PAINEL DE AÇÃO (SALESFORCE STYLE) --- */
        .action-panel {
            background: var(--bg-panel);
            padding: 40px 32px;
            overflow-y: auto;
            display: flex; flex-direction: column;
        }

        .panel-header { margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--card-border); }
        .panel-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        
        /* Formulários */
        .form-group { margin-bottom: 24px; }
        label { display: block; color: var(--text-secondary); margin-bottom: 10px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea {
            width: 100%;
            background: var(--bg-absolute);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            padding: 14px 16px;
            border-radius: var(--radius-sm);
            font-family: 'Manrope'; font-size: 14px;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 2px rgba(114, 60, 235, 0.2);
        }

        /* Botões */
        .btn {
            width: 100%; padding: 16px;
            border-radius: var(--radius-md);
            font-weight: 600; font-size: 14px;
            cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary {
            background: var(--accent-purple); color: white; border: none;
            box-shadow: 0 4px 20px rgba(114, 60, 235, 0.3);
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-secondary {
            background: transparent; border: 1px solid var(--card-border); color: var(--text-primary);
        }
        .btn-secondary:hover { background: var(--card-hover); }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid transparent;
            width: auto; padding: 8px 12px; border-radius: 8px;
        }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.2); }

        /* Empty States */
        .empty-state { text-align: center; color: var(--text-secondary); padding: 60px 0; opacity: 0.5; }

        /* Toasts */
        #toast-container { position: fixed; bottom: 32px; right: 32px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1a1a1a; border: 1px solid var(--card-border); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #10B981; } .toast.error { border-left: 4px solid #EF4444; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Responsive */
        @media (max-width: 1000px) {
            .app-grid { grid-template-columns: 80px 1fr 0px; }
            .sidebar { padding: 20px 10px; align-items: center; }
            .brand-text, .nav-text { display: none; }
            .action-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 100%; z-index: 50; background: var(--bg-panel); border-left: 1px solid var(--card-border); }
            .action-panel.open { display: flex; width: 85%; box-shadow: -20px 0 50px rgba(0,0,0,0.5); }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="app-grid">
        
        <aside class="sidebar">
            <div>
                <div class="brand">
                    <div class="brand-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
                    <span class="brand-text">Storm Pro</span>
                </div>

                <ul class="nav-menu">
                    <li class="nav-item active" onclick="app.navigate('disparo', this)">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                        <span class="nav-text">Disparar</span>
                    </li>
                    
                    <li class="nav-item" onclick="app.navigate('grupos', this)">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span class="nav-text">Grupos</span>
                    </li>
                    
                    <li class="nav-item" onclick="app.navigate('templates', this)">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        <span class="nav-text">Templates</span>
                    </li>
                    
                    <li class="nav-item" onclick="app.navigate('fluxos', this)">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        <span class="nav-text">Fluxos</span>
                    </li>
                </ul>
            </div>

            <div style="padding-top: 20px; border-top: 1px solid var(--card-border);">
                <div style="display:flex; gap:12px; align-items:center; opacity:0.6;">
                    <div style="width:24px; height:24px; border-radius:50%; background:#333;"></div>
                    <span style="font-size:12px;">Matheus (CEO)</span>
                </div>
            </div>
        </aside>

        <main class="main-list">
            <header>
                <div>
                    <h1 id="pageTitle">Inbox</h1>
                    <div class="subtitle" id="pageSubtitle">Gerencie suas campanhas ativas</div>
                </div>
                <button class="btn btn-secondary" style="width:auto;" onclick="app.openCreatePanel()">
                    + Adicionar Novo
                </button>
            </header>

            <div id="contentArea" class="cards-container">
                </div>
        </main>

        <aside class="action-panel" id="actionPanel">
            <div id="defaultPanelContent" style="text-align:center; color:var(--text-secondary); margin-top:50%;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                <p style="margin-top:16px;">Selecione um item ou<br>crie um novo para editar.</p>
            </div>

            <div id="dynamicForm" style="display:none;">
                <div class="panel-header">
                    <div style="font-size:12px; color:var(--accent-orange); font-weight:700; margin-bottom:4px;">EDITOR</div>
                    <div class="panel-title" id="formTitle">Novo Item</div>
                </div>
                <div id="formFields"></div>
                <div style="margin-top:32px; display:flex; gap:12px;">
                    <button class="btn btn-primary" onclick="app.saveCurrent()">Salvar Alterações</button>
                    <button class="btn btn-secondary" onclick="app.closePanel()">Cancelar</button>
                </div>
            </div>
        </aside>

    </div>

    <script>
        // --- LÓGICA DO SISTEMA ---
        
        const app = {
            currentView: 'disparo',
            data: { grupos: [], templates: [], fluxos: [] },
            currentItemId: null, // ID do item sendo editado no painel direito

            init: async () => {
                await app.fetchData();
                app.navigate('disparo', document.querySelector('.nav-item.active'));
            },

            fetchData: async () => {
                try {
                    const [g, t, f] = await Promise.all([
                        fetch('/api/groups').then(r => r.json()),
                        fetch('/api/templates').then(r => r.json()),
                        fetch('/api/flows').then(r => r.json())
                    ]);
                    app.data.grupos = g;
                    app.data.templates = t;
                    app.data.fluxos = f;
                } catch (e) { console.error(e); }
            },

            // Navegação entre as telas
            navigate: (view, el) => {
                app.currentView = view;
                
                // Atualiza Sidebar
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                if(el) el.classList.add('active');

                // Atualiza Títulos
                const titles = {
                    'disparo': ['Disparo Rápido', 'Envie campanhas em massa agora'],
                    'grupos': ['Grupos de E-mail', 'Organize seus contatos e clientes'],
                    'templates': ['Modelos de E-mail', 'Crie designs reutilizáveis'],
                    'fluxos': ['Fluxos de Automação', 'Crie sequências temporais']
                };
                document.getElementById('pageTitle').innerText = titles[view][0];
                document.getElementById('pageSubtitle').innerText = titles[view][1];

                // Renderiza Lista Central
                app.renderList();
                
                // Reseta Painel Direito
                app.closePanel();
            },

            // Renderiza os Cards na Coluna do Meio
            renderList: () => {
                const container = document.getElementById('contentArea');
                let html = '';

                if (app.currentView === 'disparo') {
                    // Tela de Disparo (Customizada)
                    html = `
                        <div class="card-item" style="cursor:default;">
                            <div class="form-group">
                                <label>Selecione o Grupo</label>
                                <select id="sendGrupo">${app.data.grupos.map(g=>`<option value="${g.id}">${g.nome}</option>`).join('')}</select>
                            </div>
                            <div class="form-group">
                                <label>Ou e-mails avulsos</label>
                                <textarea id="sendAvulsos" rows="3" placeholder="email@exemplo.com"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Selecione o Template</label>
                                <select id="sendTemplate">${app.data.templates.map(t=>`<option value="${t.id}">${t.nome}</option>`).join('')}</select>
                            </div>
                            <button class="btn btn-primary" onclick="app.startSending()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2Z"/></svg>
                                Iniciar Disparo
                            </button>
                        </div>
                    `;
                } 
                else if (app.currentView === 'grupos') {
                    html = app.data.grupos.map(g => `
                        <div class="card-item" onclick="app.editItem(${g.id})">
                            <div class="card-header">
                                <div class="card-meta">
                                    <div class="avatar purple-gradient">G</div>
                                    <div>
                                        <div class="card-title">${g.nome}</div>
                                        <div class="card-preview">${g.emails ? g.emails.length : 0} contatos</div>
                                    </div>
                                </div>
                                <span class="tag orange">Lista</span>
                            </div>
                        </div>
                    `).join('');
                }
                else if (app.currentView === 'templates') {
                    html = app.data.templates.map(t => `
                        <div class="card-item" onclick="app.editItem(${t.id})">
                            <div class="card-header">
                                <div class="card-meta">
                                    <div class="avatar" style="background:#333"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg></div>
                                    <div>
                                        <div class="card-title">${t.nome}</div>
                                        <div class="card-preview">${t.assunto}</div>
                                    </div>
                                </div>
                                <span class="tag purple">HTML</span>
                            </div>
                        </div>
                    `).join('');
                }
                else if (app.currentView === 'fluxos') {
                    html = app.data.fluxos.map(f => `
                        <div class="card-item" onclick="app.editItem(${f.id})">
                            <div class="card-header">
                                <div class="card-meta">
                                    <div class="avatar" style="background:#22c55e"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
                                    <div>
                                        <div class="card-title">${f.nome}</div>
                                        <div class="card-preview">${f.steps.length} passos de automação</div>
                                    </div>
                                </div>
                                <span class="tag orange">Auto</span>
                            </div>
                        </div>
                    `).join('');
                }

                container.innerHTML = html || '<div class="empty-state">Nenhum item encontrado.</div>';
            },

            // --- LÓGICA DO PAINEL DIREITO (SALESFORCE VIEW) ---
            
            openCreatePanel: () => {
                if(app.currentView === 'disparo') return; // Sem criação na tela de disparo
                app.currentItemId = null; // Modo Criação
                app.renderForm();
            },

            editItem: (id) => {
                app.currentItemId = id; // Modo Edição
                app.renderForm();
            },

            closePanel: () => {
                document.getElementById('defaultPanelContent').style.display = 'block';
                document.getElementById('dynamicForm').style.display = 'none';
                // Mobile
                document.querySelector('.action-panel').classList.remove('open');
            },

            renderForm: () => {
                const container = document.getElementById('formFields');
                const title = document.getElementById('formTitle');
                let fields = '';
                
                // Abre o painel
                document.getElementById('defaultPanelContent').style.display = 'none';
                document.getElementById('dynamicForm').style.display = 'block';
                // Mobile trigger
                document.querySelector('.action-panel').classList.add('open');

                if (app.currentView === 'grupos') {
                    const item = app.currentItemId ? app.data.grupos.find(x => x.id === app.currentItemId) : { nome: '', emails: [] };
                    title.innerText = app.currentItemId ? 'Editar Grupo' : 'Novo Grupo';
                    fields = `
                        <div class="form-group"><label>Nome do Grupo</label><input id="f_nome" value="${item.nome}"></div>
                        <div class="form-group"><label>Lista de E-mails</label><textarea id="f_emails" rows="10" placeholder="Um por linha...">${item.emails ? item.emails.join('\n') : ''}</textarea></div>
                    `;
                }
                else if (app.currentView === 'templates') {
                    const item = app.currentItemId ? app.data.templates.find(x => x.id === app.currentItemId) : { nome: '', assunto: '', html: '' };
                    title.innerText = app.currentItemId ? 'Editar Template' : 'Novo Template';
                    fields = `
                        <div class="form-group"><label>Nome Interno</label><input id="f_nome" value="${item.nome}"></div>
                        <div class="form-group"><label>Assunto</label><input id="f_assunto" value="${item.assunto}"></div>
                        <div class="form-group"><label>HTML do E-mail</label><textarea id="f_html" rows="15" style="font-family:monospace; font-size:12px;">${item.html}</textarea></div>
                        <div style="display:flex; gap:10px;"><button class="btn btn-secondary" style="padding:8px" onclick="app.insertTag('<img src=...>')">IMG</button><button class="btn btn-secondary" style="padding:8px" onclick="app.insertTag('<a href=...>')">LINK</button></div>
                    `;
                }
                else if (app.currentView === 'fluxos') {
                    const item = app.currentItemId ? app.data.fluxos.find(x => x.id === app.currentItemId) : { nome: '', steps: [] };
                    title.innerText = app.currentItemId ? 'Editar Fluxo' : 'Novo Fluxo';
                    
                    // Renderizador de passos simplificado para o exemplo
                    const stepsHtml = (item.steps || []).map((s, i) => `
                        <div style="background:#151515; padding:10px; border-radius:8px; margin-bottom:8px; border:1px dashed #333;">
                            <div style="font-size:11px; color:#666; margin-bottom:4px;">PASSO ${i+1}</div>
                            <div style="font-weight:600;">Template ID: ${s.templateId}</div>
                            <div style="font-size:12px;">Espera: ${s.delay}h</div>
                        </div>
                    `).join('');

                    fields = `
                        <div class="form-group"><label>Nome da Campanha</label><input id="f_nome" value="${item.nome}"></div>
                        <label>Sequência (Simplificada)</label>
                        ${stepsHtml}
                        <div style="padding:10px; background:rgba(244, 137, 60, 0.1); border:1px solid rgba(244, 137, 60, 0.3); border-radius:8px; font-size:12px; color:#FDBA74; margin-top:10px;">
                            ⚠ Para editar passos complexos, delete e recrie o fluxo. (Versão Lite)
                        </div>
                        <input type="hidden" id="f_steps_json" value='${JSON.stringify(item.steps || [])}'>
                    `;
                }

                // Adiciona botão de excluir se for edição
                if(app.currentItemId) {
                    fields += `<div style="margin-top:40px; border-top:1px solid var(--card-border); padding-top:20px;"><button class="btn btn-delete" onclick="app.deleteCurrent()">Excluir Item</button></div>`;
                }

                container.innerHTML = fields;
            },

            // CRUD Operations
            saveCurrent: async () => {
                const id = app.currentItemId;
                const method = id ? 'PUT' : 'POST';
                let body = {};

                if (app.currentView === 'grupos') {
                    body = {
                        id: id,
                        nome: document.getElementById('f_nome').value,
                        emails: document.getElementById('f_emails').value.split('\n').map(e=>e.trim()).filter(e=>e.includes('@'))
                    };
                } else if (app.currentView === 'templates') {
                    body = {
                        id: id,
                        nome: document.getElementById('f_nome').value,
                        assunto: document.getElementById('f_assunto').value,
                        html: document.getElementById('f_html').value
                    };
                } else if (app.currentView === 'fluxos') {
                    // Simplificação: Salvando apenas nome no modo edição simples
                    body = {
                        id: id,
                        nome: document.getElementById('f_nome').value,
                        steps: JSON.parse(document.getElementById('f_steps_json').value)
                    };
                }

                await fetch(`/api/${app.currentView}`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                app.showToast('Salvo com sucesso!', 'success');
                app.fetchData().then(() => app.renderList());
            },

            deleteCurrent: async () => {
                if(!confirm("Tem certeza?")) return;
                await fetch(`/api/${app.currentView}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: app.currentItemId })
                });
                app.showToast('Item excluído.', 'success');
                app.fetchData().then(() => {
                    app.renderList();
                    app.closePanel();
                });
            },

            // Helpers
            insertTag: (tag) => {
                document.getElementById('f_html').value += tag;
            },

            showToast: (msg, type) => {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `<span>${msg}</span>`;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },

            startSending: async () => {
                // Lógica de disparo mantida
                const gid = document.getElementById('sendGrupo').value;
                const tid = document.getElementById('sendTemplate').value;
                const avulsos = document.getElementById('sendAvulsos').value;
                
                let list = [];
                if(gid) { const g = app.data.grupos.find(x=>x.id==gid); if(g) list = [...g.emails]; }
                if(avulsos) list = [...list, ...avulsos.split('\n').filter(e=>e.includes('@'))];
                list = [...new Set(list)];

                if(!list.length) return app.showToast('Sem e-mails para enviar', 'error');
                if(!confirm(`Disparar para ${list.length} pessoas?`)) return;

                const tmpl = app.data.templates.find(x=>x.id==tid);
                const subj = tmpl ? tmpl.assunto : 'Aviso';
                const html = tmpl ? tmpl.html : 'Olá';

                app.showToast('Iniciando envio...', 'success');
                
                for(let i=0; i<list.length; i+=5) {
                    const batch = list.slice(i, i+5);
                    await Promise.all(batch.map(email => 
                        fetch('/api/send', {
                            method:'POST', headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({email, subject:subj, html})
                        })
                    ));
                    await new Promise(r=>setTimeout(r, 1000));
                }
                app.showToast('Envio concluído!', 'success');
            }
        };

        // Inicializa
        app.init();

    </script>
</body>
</html>