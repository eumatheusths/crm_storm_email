---
---

<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storm Email Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM (CORRIGIDO) --- */
        :root {
            --bg-deep: #050505;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.07);
            --border-glass: rgba(255, 255, 255, 0.08);
            
            --accent-primary: #7c3aed;
            --accent-gradient: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            
            --radius-xl: 20px;
            --radius-md: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, rgba(124, 58, 237, 0.15), transparent 50%);
            color: var(--text-primary); 
            height: 100vh; 
            display: flex; 
            font-family: 'Archivo', sans-serif;
            overflow: hidden;
        }

        h1, h2, h3 { font-family: 'Syne', sans-serif; }

        /* --- LAYOUT --- */
        .app-container { display: flex; height: 100%; width: 100%; }
        
        aside { 
            width: 280px; 
            padding: 30px 20px; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--border-glass);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            z-index: 10;
        }

        /* --- COMPONENTES VISUAIS --- */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-glass);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .glass-input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-glass);
            color: white;
            border-radius: var(--radius-md);
            font-family: 'Archivo';
            margin-bottom: 15px;
            outline: none;
            transition: 0.3s;
        }
        .glass-input:focus { border-color: var(--accent-primary); background: rgba(0,0,0,0.6); }

        /* Botões da Sidebar */
        .nav-btn { 
            background: transparent; border: none; color: var(--text-secondary); 
            padding: 12px; text-align: left; cursor: pointer; border-radius: var(--radius-md); 
            margin-bottom: 8px; font-size: 0.95rem; font-weight: 500; 
            display: flex; align-items: center; gap: 12px; width: 100%; transition: all 0.2s;
        }
        
        .nav-icon-box {
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); transition: 0.2s;
        }

        .nav-btn:hover { color: white; background: var(--bg-glass-hover); }
        .nav-btn:hover .nav-icon-box { background: rgba(255,255,255,0.1); color: white; }

        .nav-btn.active { color: white; background: var(--bg-glass-hover); border: 1px solid var(--border-glass); }
        .nav-btn.active .nav-icon-box { background: var(--accent-gradient); color: white; box-shadow: 0 0 15px rgba(124, 58, 237, 0.4); }

        /* Conteúdo Principal */
        main { flex: 1; padding: 40px; overflow-y: auto; }
        .screen { display: none; max-width: 900px; margin: 0 auto; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LISTA DE ITENS (AQUI ESTAVA O PROBLEMA) --- */
        .list-item { 
            display: flex !important; /* Força o alinhamento horizontal */
            justify-content: space-between; 
            align-items: center; 
            padding: 20px; 
            background: rgba(20, 20, 25, 0.6);
            border: 1px solid var(--border-glass);
            border-radius: 18px;
            margin-bottom: 12px;
            transition: 0.2s;
        }
        .list-item:hover { transform: translateY(-2px); border-color: rgba(124, 58, 237, 0.4); background: rgba(30, 30, 35, 0.8); }

        .item-left { display: flex; align-items: center; gap: 16px; }
        
        .item-icon {
            width: 48px; height: 48px;
            border-radius: 14px;
            background: rgba(124, 58, 237, 0.1);
            color: #a78bfa;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .item-info strong { display: block; font-size: 1.05rem; margin-bottom: 4px; }
        .item-info small { color: var(--text-secondary); font-size: 0.85rem; }

        .item-actions { display: flex; gap: 8px; }

        /* Botões de Ação (Lápis/Lixo) */
        .action-btn { 
            width: 40px; height: 40px; 
            border-radius: 10px; border: 1px solid var(--border-glass);
            background: rgba(255,255,255,0.03); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; }
        .action-btn.delete:hover { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: #f87171; }

        /* Botões Principais */
        button.primary { 
            background: var(--accent-gradient); color: white; border: none; 
            padding: 16px 32px; border-radius: 14px; font-weight: 600; width: 100%; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4); cursor: pointer;
        }
        button.secondary { 
            background: transparent; border: 1px solid var(--border-glass); color: white; 
            padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; cursor: pointer;
        }

        /* Toasts e Widgets */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px 24px; border-radius: 16px; background: #121212; border: 1px solid var(--border-glass); color: white; display: flex; gap: 12px; align-items: center; border-left: 4px solid #7c3aed; animation: slideIn 0.3s; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            aside { position: fixed; bottom: 0; width: 100%; height: 75px; flex-direction: row; justify-content: space-around; padding: 10px; } 
            aside h1 { display: none; }
            .nav-btn { flex-direction: column; padding: 0; gap: 4px; justify-content: center; width: auto; background: none !important; font-size: 0.7rem; border: none !important;}
            .nav-icon-box { width: 32px; height: 32px; margin: 0 auto; }
            main { padding: 20px; padding-bottom: 100px; }
        }
        
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="app-container">
        <aside>
            <h1 style="font-size:1.5rem; font-weight:800; margin-bottom:40px; display:flex; gap:10px; align-items:center;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Storm Pro
            </h1>

            <button class="nav-btn active" onclick="window.showScreen('disparo')">
                <div class="nav-icon-box"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></div>
                <span>Disparar</span>
            </button>
            <button class="nav-btn" onclick="window.showScreen('grupos')">
                <div class="nav-icon-box"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
                <span>Grupos</span>
            </button>
            <button class="nav-btn" onclick="window.showScreen('templates')">
                <div class="nav-icon-box"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
                <span>Templates</span>
            </button>
            <button class="nav-btn" onclick="window.showScreen('fluxos')">
                <div class="nav-icon-box"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-2v5H6v2h2v5h2v-5h2v-2z"/></svg></div>
                <span>Fluxos</span>
            </button>
        </aside>

        <main>
            <div id="disparo" class="screen active">
                <h2 style="margin-bottom:30px; font-size:2rem; font-weight:700;">Disparo Rápido</h2>
                <div class="glass-panel" style="padding:30px; border-radius:24px; margin-bottom:20px;">
                    <label>Para quem enviar?</label>
                    <select id="selectGrupoEnvio" class="glass-input"><option value="">Carregando...</option></select>
                    <textarea id="emailsAvulsos" class="glass-input" placeholder="Ou cole e-mails aqui (um por linha)..." style="height: 80px;"></textarea>
                </div>
                <div class="glass-panel" style="padding:30px; border-radius:24px; margin-bottom:30px;">
                    <label>Qual mensagem?</label>
                    <select id="selectTemplateEnvio" class="glass-input"><option value="">-- Manual --</option></select>
                </div>
                <button class="primary" id="btnStart">INICIAR DISPARO</button>
            </div>

            <div id="grupos" class="screen">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="margin:0;">Grupos</h2>
                    <button class="secondary" onclick="window.novoGrupo()">+ Novo</button>
                </div>
                
                <div id="listaGruposUI"></div>

                <div class="glass-panel" id="formGrupo" style="display:none; padding:30px; border-radius:24px; border:1px solid #7c3aed; margin-bottom:30px;">
                    <h3 style="margin-bottom:20px;">Novo Grupo</h3>
                    <input type="hidden" id="grupoId">
                    <label>Nome do Grupo</label><input type="text" id="grupoNome" class="glass-input">
                    <label>Lista de E-mails</label><textarea id="grupoEmails" class="glass-input" style="height:150px;"></textarea>
                    <div style="display:flex; gap:10px;">
                        <button class="secondary" onclick="document.getElementById('formGrupo').style.display='none'">Cancelar</button>
                        <button class="primary" onclick="window.salvarGrupo()">Salvar</button>
                    </div>
                </div>
            </div>

            <div id="templates" class="screen">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="margin:0;">Templates</h2>
                    <button class="secondary" onclick="window.novoTemplate()">+ Novo</button>
                </div>
                
                <div id="listaTemplatesUI"></div>

                <div class="glass-panel" id="formTemplate" style="display:none; padding:30px; border-radius:24px; border:1px solid #7c3aed; margin-bottom:30px;">
                    <h3 style="margin-bottom:20px;">Novo Template</h3>
                    <input type="hidden" id="tempId">
                    <label>Nome Interno</label><input type="text" id="tempNome" class="glass-input">
                    <label>Assunto do E-mail</label><input type="text" id="tempAssunto" class="glass-input">
                    <label>Conteúdo HTML</label><textarea id="tempHtml" class="glass-input" style="height:200px; font-family:monospace;"></textarea>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="secondary" onclick="document.getElementById('formTemplate').style.display='none'">Cancelar</button>
                        <button class="primary" onclick="window.salvarTemplate()">Salvar</button>
                    </div>
                </div>
            </div>

            <div id="fluxos" class="screen">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="margin:0;">Fluxos</h2>
                    <button class="secondary" onclick="window.novoFluxo()">+ Criar</button>
                </div>
                <div id="listaFluxosUI"></div>
                <div class="glass-panel" id="formFluxo" style="display:none; padding:30px; border-radius:24px; border:1px solid #7c3aed;">
                    <h3>Editor de Fluxo</h3>
                    <label>Nome da Campanha</label><input type="text" id="flowNome" class="glass-input">
                    <div id="stepsContainer" style="margin:20px 0;"></div>
                    <button class="secondary" onclick="window.adicionarPasso()" style="width:100%; margin-bottom:20px; border-style:dashed;">+ Adicionar Passo</button>
                    <button class="primary" onclick="window.salvarFluxo()">Salvar Fluxo</button>
                </div>
            </div>
        </main>
    </div>

   <script>
        // --- FUNÇÕES DE RENDERIZAÇÃO (CARDS DESIGN) ---

        function renderGrupos() {
            const ui = document.getElementById('listaGruposUI');
            // Adicionamos a classe grid-container
            ui.className = 'grid-container'; 
            
            if(!cache.grupos.length) { 
                ui.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#555;">Nenhum grupo criado.</div>'; 
                return; 
            }
            
            ui.innerHTML = cache.grupos.map((g, index) => {
                // Alterna estilos para dar vida (igual a ref)
                const isHighlight = index === 0; // O primeiro destaque
                const cardClass = isHighlight ? 'dashboard-card highlight' : 'dashboard-card';
                const pillClass = isHighlight ? 'pill yellow' : 'pill dark';
                
                return `
                <div class="${cardClass}">
                    <div class="card-top">
                        <div class="card-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="window.editarGrupo(${g.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="icon-btn delete" onclick="window.deletarGrupo(${g.id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <h3>${g.nome}</h3>
                        <p>${g.emails ? g.emails.length : 0} contatos ativos</p>
                        <div class="card-tags">
                            <span class="${pillClass}">ATIVO</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTemplates() {
            const ui = document.getElementById('listaTemplatesUI');
            ui.className = 'grid-container';

            if(!cache.templates.length) { ui.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#555;">Nenhum template.</div>'; return; }

            ui.innerHTML = cache.templates.map((t, index) => {
                // Alterna gradientes para diferenciar
                const isHighlight = index === 1; 
                const cardStyle = isHighlight ? 'background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); border:none;' : '';
                const titleColor = isHighlight ? 'color:white' : '';
                
                return `
                <div class="dashboard-card" style="${cardStyle}">
                    <div class="card-top">
                        <div class="card-icon" style="${isHighlight ? 'background:rgba(255,255,255,0.2); color:white;' : ''}">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="window.editarTemplate(${t.id})">✎</button>
                            <button class="icon-btn delete" onclick="window.deletarTemplate(${t.id})">✕</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <h3 style="${titleColor}">${t.nome}</h3>
                        <p style="${titleColor ? 'color:rgba(255,255,255,0.8)' : ''}">${t.assunto}</p>
                        <div class="card-tags">
                            <span class="pill dark">HTML</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderFluxos() {
            const ui = document.getElementById('listaFluxosUI');
            ui.className = 'grid-container';
            
            if(!cache.fluxos.length) { ui.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#555;">Nenhum fluxo.</div>'; return; }

            ui.innerHTML = cache.fluxos.map(f => `
                <div class="dashboard-card">
                    <div class="card-top">
                        <div class="card-icon" style="background: rgba(16, 185, 129, 0.1); color:#10b981;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h-2v5H6v2h2v5h2v-5h2v-2z"/></svg>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn delete" onclick="window.deletarFluxo(${f.id})">✕</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <h3>${f.nome}</h3>
                        <p>${f.steps.length} passos de automação</p>
                        <div class="card-tags">
                            ${f.steps.map(s => `<span class="pill purple">+${s.delay}h</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- SISTEMA ---
        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            // Ícones SVG no toast
            let icon = type==='success' ? '✅' : type==='error' ? '❌' : 'ℹ️';
            toast.innerHTML = `<span style="font-size:1.2rem">${icon}</span><span>${msg}</span>`;
            if(type==='success') toast.style.borderLeftColor = '#4ade80';
            if(type==='error') toast.style.borderLeftColor = '#f87171';
            container.appendChild(toast);
            setTimeout(()=>toast.remove(), 3000);
        }

        let cache = { grupos: [], templates: [], fluxos: [] };
        let currentFlowSteps = [];

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const map = {'disparo':0, 'grupos':1, 'templates':2, 'fluxos':3};
            document.querySelectorAll('.nav-btn')[map[id]].classList.add('active');
            carregarDados();
        };

        async function carregarDados() {
            try {
                const g = await fetch('/api/groups'); cache.grupos = await g.json();
                const t = await fetch('/api/templates'); cache.templates = await t.json();
                const f = await fetch('/api/flows'); cache.fluxos = await f.json();
                renderAll();
            } catch(e) { console.error(e); }
        }

        function renderAll() { renderGrupos(); renderTemplates(); renderFluxos(); populateSelects(); }
        
        function populateSelects() {
            const opts = '<option value="">-- Selecione --</option>' + cache.templates.map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
            document.getElementById('selectTemplateEnvio').innerHTML = opts;
            const gOpts = '<option value="">-- Selecione --</option>' + cache.grupos.map(g=>`<option value="${g.id}">${g.nome}</option>`).join('');
            document.getElementById('selectGrupoEnvio').innerHTML = gOpts;
        }

        // CRUD (Mantenha o mesmo do anterior, está funcionando bem)
        window.novoGrupo = () => { document.getElementById('grupoId').value=''; document.getElementById('grupoNome').value=''; document.getElementById('grupoEmails').value=''; document.getElementById('formGrupo').style.display='block'; }
        window.editarGrupo = (id) => { const g=cache.grupos.find(x=>x.id===id); if(g){ document.getElementById('grupoId').value=g.id; document.getElementById('grupoNome').value=g.nome; document.getElementById('grupoEmails').value=g.emails.join('\n'); document.getElementById('formGrupo').style.display='block'; } }
        window.salvarGrupo = async () => {
            const id=document.getElementById('grupoId').value, nome=document.getElementById('grupoNome').value, emails=document.getElementById('grupoEmails').value.split('\n').map(e=>e.trim()).filter(e=>e.includes('@'));
            if(!nome || !emails.length) return showToast('Preencha tudo', 'error');
            await fetch('/api/groups', { method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, nome, emails}) });
            document.getElementById('formGrupo').style.display='none'; showToast('Salvo!', 'success'); carregarDados();
        }
        window.deletarGrupo = async (id) => { if(confirm('Apagar?')) { await fetch('/api/groups', {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); showToast('Apagado', 'success'); carregarDados(); } }

        window.novoTemplate = () => { document.getElementById('tempId').value=''; document.getElementById('tempNome').value=''; document.getElementById('tempAssunto').value=''; document.getElementById('tempHtml').value=''; document.getElementById('formTemplate').style.display='block'; }
        window.editarTemplate = (id) => { const t=cache.templates.find(x=>x.id===id); if(t){ document.getElementById('tempId').value=t.id; document.getElementById('tempNome').value=t.nome; document.getElementById('tempAssunto').value=t.assunto; document.getElementById('tempHtml').value=t.html; document.getElementById('formTemplate').style.display='block'; } }
        window.salvarTemplate = async () => {
            const id=document.getElementById('tempId').value, nome=document.getElementById('tempNome').value, assunto=document.getElementById('tempAssunto').value, html=document.getElementById('tempHtml').value;
            if(!nome || !assunto) return showToast('Preencha tudo', 'error');
            await fetch('/api/templates', { method: id?'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, nome, assunto, html}) });
            document.getElementById('formTemplate').style.display='none'; showToast('Salvo!', 'success'); carregarDados();
        }
        window.deletarTemplate = async (id) => { if(confirm('Apagar?')) { await fetch('/api/templates', {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); showToast('Apagado', 'success'); carregarDados(); } }

        // FLUXOS
        window.novoFluxo = () => { currentFlowSteps=[{templateId:'', delay:0}]; document.getElementById('flowNome').value=''; renderStepsEditor(); document.getElementById('formFluxo').style.display='block'; }
        window.adicionarPasso = () => { currentFlowSteps.push({templateId:'', delay:24}); renderStepsEditor(); }
        window.removerPasso = (i) => { currentFlowSteps.splice(i,1); renderStepsEditor(); }
        window.updateStepData = (i, f, v) => { currentFlowSteps[i][f]=v; }
        function renderStepsEditor() {
            const opts='<option value="">Selecione...</option>'+cache.templates.map(t=>`<option value="${t.id}">${t.nome}</option>`).join('');
            document.getElementById('stepsContainer').innerHTML = currentFlowSteps.map((s,i)=>`
                <div style="position:relative; padding-left:30px; margin-bottom:20px; border-left:2px dashed rgba(255,255,255,0.1);">
                    <div style="position:absolute; left:-9px; top:20px; width:16px; height:16px; border-radius:50%; background:#09090b; border:2px solid #8b5cf6;"></div>
                    <div style="padding:20px; display:flex; gap:15px; align-items:center; background:rgba(255,255,255,0.05); border-radius:12px;">
                        <div style="font-family:'Syne'; font-size:1.5rem; opacity:0.2;">${i+1}</div>
                        <div style="flex:1">
                            <label>Modelo:</label><select class="glass-input" style="margin-bottom:10px;" onchange="window.updateStepData(${i},'templateId',this.value)">${opts.replace(`value="${s.templateId}"`,`value="${s.templateId}" selected`)}</select>
                            <label>Esperar (Horas):</label><input type="number" class="glass-input" value="${s.delay}" style="margin-bottom:0;" onchange="window.updateStepData(${i},'delay',this.value)">
                        </div>
                        <button class="icon-btn delete" onclick="window.removerPasso(${i})">X</button>
                    </div>
                </div>`).join('');
        }
        window.salvarFluxo = async () => {
            const nome=document.getElementById('flowNome').value; if(!nome||currentFlowSteps.some(s=>!s.templateId)) return showToast('Erro', 'error');
            await fetch('/api/flows', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nome, steps:currentFlowSteps})});
            document.getElementById('formFluxo').style.display='none'; showToast('Salvo', 'success'); carregarDados();
        }
        window.deletarFluxo = async (id) => { if(confirm('Apagar?')) { await fetch('/api/flows', {method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); carregarDados(); } }

        // DISPARO (MANTÉM O MESMO DO ÚLTIMO, FUNCIONA BEM)
        document.getElementById('btnStart').addEventListener('click', async () => {
            const gid=document.getElementById('selectGrupoEnvio').value, tid=document.getElementById('selectTemplateEnvio').value, avulsos=document.getElementById('emailsAvulsos').value;
            let list=[]; if(gid){const g=cache.grupos.find(x=>x.id==gid); if(g) list=[...g.emails];} if(avulsos) list=[...list, ...avulsos.split('\n').filter(e=>e.includes('@'))]; list=[...new Set(list)];
            if(!list.length) return showToast('Sem emails', 'error');
            let subj='', html=''; if(tid){const t=cache.templates.find(x=>x.id==tid); subj=t.assunto; html=t.html;} else {subj='Aviso'; html='<p>Olá</p>';} 
            if(!confirm(`Enviar para ${list.length}?`)) return;

            const btn=document.getElementById('btnStart'); btn.disabled=true; btn.innerText = "ENVIANDO...";
            let suc=0, err=0;
            for(let i=0; i<list.length; i+=5) {
                const batch=list.slice(i, i+5);
                await Promise.all(batch.map(e=>fetch('/api/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:e, subject:subj, html})}).then(r=>r.ok?suc++:err++)));
                await new Promise(r=>setTimeout(r,1000));
            }
            showToast(`Sucesso: ${suc} | Erros: ${err}`, 'success'); btn.disabled=false; btn.innerText = "INICIAR DISPARO";
        });

        carregarDados();
    </script>
</body>
</html>